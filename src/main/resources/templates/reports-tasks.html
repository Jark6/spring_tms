<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="EN">
<head>
    <title>Список задач</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
</head>
<body>
<header th:insert="~{blocks/header :: header}"></header>
<div class="container mt-5">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <h1>Отчет по задачам</h1>
            </div>
        </div>
    </div>
    <div th:insert="~{blocks/reports-menu::reports-menu}"></div>
    <div th:insert="~{blocks/reports-dates::reports-dates}"></div>
    <div class="container d-flex align-items-center justify-content-center">
    <div style="width: 400px;">
        <canvas id="pieChartStatus"></canvas>
    </div>
    <div style="width: 400px;">
        <canvas id="pieChartTaskType"></canvas>
    </div>
        <div style="width: 400px;">
            <canvas id="pieChartPriority"></canvas>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Функция для назначения произвольного цвета
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    fetch('/api')
        .then(response => response.json())
        .then(tasksData => {
            // Создаем объект для отслеживания количества задач для статуса
            const tasksCountByStatus = {};
            // Создаем объект для отслеживания количества задач для типа задачи
            const tasksCountByTaskType = {};
            // Создаем объект для отслеживания количества задач для приоритета
            const tasksCountByPriority = {};
            // Подсчитываем количество задач для каждого статуса
            tasksData.forEach(task => {
                const statusName = task.status_id ? task.status_id.status  : 'Статус отсутсвует';
                tasksCountByStatus[statusName] = (tasksCountByStatus[statusName] || 0) + 1;
                const typeName = task.task_type_id ? task.task_type_id.task_type  : 'Тип задачи отсутсвует';
                tasksCountByTaskType[typeName] = (tasksCountByTaskType[typeName] || 0) + 1;
                const priorityName = task.priority_id ? task.priority_id.priority  : 'Срочность отсутсвует';
                tasksCountByPriority[priorityName] = (tasksCountByPriority[priorityName] || 0) + 1;
            });

            // Преобразование данных в формат, ожидаемый Chart.js
            const labels = Object.keys(tasksCountByStatus);
            const data = Object.values(tasksCountByStatus);
            const labels1 = Object.keys(tasksCountByTaskType);
            const data1 = Object.values(tasksCountByTaskType);
            const labels2 = Object.keys(tasksCountByPriority);
            const data2 = Object.values(tasksCountByPriority);
            // Генерация случайных цветов для backgroundColor
            const backgroundColor = Array.from({ length: tasksData.length }, () => getRandomColor());

            // Создание круговой диаграммы
            const ptx = document.getElementById('pieChartStatus');
            new Chart(ptx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Задачи',
                        data: data,
                        backgroundColor: backgroundColor,
                        hoverOffset: 4,
                        borderWidth: 1
                    }]
                },
            });
            const btx = document.getElementById('pieChartTaskType');
            new Chart(btx, {
                type: 'pie',
                data: {
                    labels: labels1,
                    datasets: [{
                        label: 'Задачи',
                        data: data1,
                        backgroundColor: backgroundColor,
                        hoverOffset: 4,
                        borderWidth: 1
                    }]
                },
            });

            const ctx = document.getElementById('pieChartPriority');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels2,
                    datasets: [{
                        label: 'Задачи',
                        data: data2,
                        backgroundColor: backgroundColor,
                        hoverOffset: 4,
                        borderWidth: 1
                    }]
                },
            });
        })
        .catch(error => console.error('Error fetching data:', error));

</script>
<div th:insert="~{blocks/footer :: footer}"></div>
</body>
</html>