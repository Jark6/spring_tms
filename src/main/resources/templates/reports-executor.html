<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="EN">
<head>
    <title>Список задач</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
</head>
<body>
<header th:insert="~{blocks/header :: header}"></header>
<div class="container mt-5">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <h1>Отчет по иcполнителям</h1>
            </div>
        </div>
    </div>
    <div th:insert="~{blocks/reports-menu::reports-menu}"></div>
    <div th:insert="~{blocks/reports-dates::reports-dates}"></div>
    <div class="container align-items-center justify-content-center">
    <div style="width: 500px;">
        <canvas id="pieChartExecutors"></canvas>
    </div>
    <div style="width: 500px;">
        <canvas id="barChartExecutors"></canvas>
    </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Функция для назначения произвольного цвета
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    fetch('/api')
        .then(response => response.json())
        .then(tasksData => {
            // Создаем объект для отслеживания количества задач для каждого исполнителя
            const tasksCountByExecutor = {};
            // Подсчитываем количество задач для каждого исполнителя
            tasksData.forEach(task => {
                let label = '';

                // Проверяем наличие исполнителя
                if (task.executor_id) {
                    label = task.executor_id.first_name + ' ' + task.executor_id.second_name;
                } else if (task.team_id) {
                    label = task.team_id.team_name;
                } else {
                    label = 'Нет исполнителя';
                }
                tasksCountByExecutor[label] = (tasksCountByExecutor[label] || 0) + 1;
            });

            // Преобразование данных в формат, ожидаемый Chart.js
            const labels = Object.keys(tasksCountByExecutor);
            const data = Object.values(tasksCountByExecutor);
            // Генерация случайных цветов для backgroundColor
            const backgroundColor = Array.from({ length: tasksData.length }, () => getRandomColor());

            // Создание круговой диаграммы
            const ptx = document.getElementById('pieChartExecutors');
            new Chart(ptx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Задачи',
                        data: data,
                        backgroundColor: backgroundColor,
                        hoverOffset: 4,
                        borderWidth: 1
                    }]
                },
            });
            const btx = document.getElementById('barChartExecutors');
            new Chart(btx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Задачи',
                        data: data,
                        backgroundColor: backgroundColor,
                        hoverOffset: 4,
                        borderWidth: 1
                    }]
                },
            });
        })
        .catch(error => console.error('Error fetching data:', error));

</script>
<div th:insert="~{blocks/footer :: footer}"></div>
</body>
</html>